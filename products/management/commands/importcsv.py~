import os
import csv

from django.core.management.base import BaseCommand, CommandError
from products.models import Product, Shop

class Command(BaseCommand):
    args = 'Model.csv pk'
    help = 'Import a csv into `Product` database.'

    def handle(self, *args, **options):
        if len(args) != 2:
            raise CommandError ("Invalid Invocation. See help.")

        csvPath = args[0]
        shop_id = args[1]
        shop = Shop.objects.get(pk=1)
        if not os.path.exists (csvPath):
            raise CommandError ("%s doesnt exist." %csvPath)
        
        model_fields = [f.name for f in Model._meta.fields]
        decoded_file = csv_file.read().decode('utf-8')
        io_string = io.StringIO(decoded_file)
        reader = csv.reader(io_string, delimiter=';')
        header_ = next(reader)
        parsed_items = []        
        with open (csvPath, 'rb') as csvFile:
            reader = csv.reader(csvFile, delimiter=';')
            header_ = reader.next()
            header_cols = [x.replace(' ', '_').lower() for x in header_.split(",")]
            for row in reader:
                try:
                    obj = Product()
                    obj.shop = shop
                    for i, field in enumerate(row):
                        setattr(obj, header_cols[i], field)
                    obj.save()
                except e:
                    raise CommandError(e)
                    

